{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p-c/Downloads/code%20%281%29/app/dashboard/products/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { createClient } from \"@/lib/supabase/client\";\nimport { Button } from \"@/components/ui/button\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\n\ninterface Product {\n  id: string;\n  name: string;\n  price: number;\n  quantity: number;\n  status: string;\n  image_url: string | null;\n  created_at: string;\n}\n\nexport default function ProductsPage() {\n  const supabase = createClient();\n\n  const [products, setProducts] = useState<Product[]>([]);\n  const [shopSlug, setShopSlug] = useState<string | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [deletingId, setDeletingId] = useState<string | null>(null);\n\n  useEffect(() => {\n    loadProducts();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const loadProducts = async () => {\n    try {\n      setLoading(true);\n\n      // 1) Récupérer l'utilisateur\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n\n      if (!user) {\n        setLoading(false);\n        return;\n      }\n\n      // 2) Récupérer la boutique de l'utilisateur (id + slug)\n      const { data: shop, error: shopError } = await supabase\n        .from(\"shops\")\n        .select(\"id, slug\")\n        .eq(\"user_id\", user.id)\n        .single();\n\n      if (shopError || !shop) {\n        console.error(\"Shop error:\", shopError);\n        setLoading(false);\n        return;\n      }\n\n      setShopSlug(shop.slug);\n\n      // 3) Charger les produits de cette boutique\n      const { data, error } = await supabase\n        .from(\"products\")\n        .select(\n          \"id, name, price, quantity, status, image_url, created_at\"\n        )\n        .eq(\"shop_id\", shop.id)\n        .order(\"created_at\", { ascending: false });\n\n      if (error) {\n        console.error(\"Products error:\", error);\n        setLoading(false);\n        return;\n      }\n\n      setProducts((data || []) as Product[]);\n    } catch (err) {\n      console.error(\"Unexpected error loading products:\", err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n const handleDeleteProduct = async (productId: string) => {\n  const confirmDelete = window.confirm(\n    \"Are you sure you want to delete this product and all related data (images, order items)?\"\n  );\n  if (!confirmDelete) return;\n\n  try {\n    setDeletingId(productId);\n\n    // 1) Supprimer les lignes de order_items liées à ce produit\n    const { error: orderItemsError } = await supabase\n      .from(\"order_items\")\n      .delete()\n      .eq(\"product_id\", productId);\n\n    if (orderItemsError) {\n      console.error(\"Error deleting order items:\", orderItemsError);\n      alert(\n        \"Failed to delete order items for this product: \" +\n          orderItemsError.message\n      );\n      setDeletingId(null);\n      return;\n    }\n\n    // 2) Supprimer les images liées dans product_images\n    const { error: imgError } = await supabase\n      .from(\"product_images\")\n      .delete()\n      .eq(\"product_id\", productId);\n\n    if (imgError) {\n      console.error(\"Error deleting product images:\", imgError);\n      // on ne bloque pas forcément la suite, mais tu peux mettre un return ici si tu veux\n    }\n\n    // 3) Supprimer le produit lui-même\n    const { error: prodError } = await supabase\n      .from(\"products\")\n      .delete()\n      .eq(\"id\", productId);\n\n    if (prodError) {\n      console.error(\"Error deleting product:\", prodError);\n      alert(\"Failed to delete product: \" + prodError.message);\n      setDeletingId(null);\n      return;\n    }\n\n    // 4) Mettre à jour la liste côté UI\n    setProducts((prev) => prev.filter((p) => p.id !== productId));\n  } catch (err: any) {\n    console.error(\"Unexpected delete error:\", err);\n    alert(\n      \"Failed to delete product: \" + (err?.message || \"Unexpected error\")\n    );\n  } finally {\n    setDeletingId(null);\n  }\n};\n\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-xl font-bold\">Produits</h1>\n        <Link href=\"/dashboard/products/new\">\n          <Button>Ajouter un produit</Button>\n        </Link>\n      </div>\n\n      {/* Contenu */}\n      {loading ? (\n        <p>Chargement...</p>\n      ) : products.length === 0 ? (\n        <div className=\"border rounded-lg p-6 text-center text-sm text-gray-500\">\n          Vous n&apos;avez encore aucun produit.\n          <br />\n          <Link href=\"/dashboard/products/new\">\n            <Button className=\"mt-3\" size=\"sm\">\n              Ajouter votre premier produit\n            </Button>\n          </Link>\n        </div>\n      ) : (\n        <div className=\"border rounded-lg divide-y bg-white\">\n          {products.map((p) => (\n            <div\n              key={p.id}\n              className=\"flex items-center gap-4 p-4 hover:bg-gray-50\"\n            >\n              {/* Image */}\n              <div className=\"h-16 w-16 overflow-hidden rounded-md border bg-gray-100 flex items-center justify-center\">\n                {p.image_url ? (\n                  <Image\n                    src={p.image_url}\n                    alt={p.name}\n                    width={64}\n                    height={64}\n                    className=\"object-cover\"\n                  />\n                ) : (\n                  <span className=\"text-[10px] text-gray-400 text-center px-1\">\n                    Aucune image\n                  </span>\n                )}\n              </div>\n\n              {/* Infos produit */}\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-semibold truncate\">{p.name}</div>\n                <div className=\"text-xs text-gray-500 mt-1\">\n                  Stock : {p.quantity} • Statut : {p.status}\n                </div>\n                <div className=\"text-xs text-gray-400 mt-0.5\">\n                  Créé le {new Date(p.created_at).toLocaleString()}\n                </div>\n              </div>\n\n              {/* Prix & actions */}\n              <div className=\"flex flex-col items-end gap-1\">\n                <div className=\"font-bold\">{p.price} TND</div>\n\n                <div className=\"flex flex-col gap-1\">\n                  {/* Modifier (admin) */}\n                  <Link href={`/dashboard/products/${p.id}`}>\n                    <Button variant=\"outline\" size=\"sm\">\n                      Modifier\n                    </Button>\n                  </Link>\n\n                  {/* Voir sur la boutique (public) */}\n                  {shopSlug && (\n                    <Link\n                      href={`/shop/${shopSlug}/product/${p.id}`}\n                      target=\"_blank\"\n                    >\n                      <Button variant=\"ghost\" size=\"sm\">\n                        Voir sur la boutique\n                      </Button>\n                    </Link>\n                  )}\n\n                  {/* Supprimer */}\n                  <Button\n                    variant=\"destructive\"\n                    size=\"sm\"\n                    onClick={() => handleDeleteProduct(p.id)}\n                    disabled={deletingId === p.id}\n                  >\n                    {deletingId === p.id ? \"Suppression...\" : \"Supprimer\"}\n                  </Button>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}