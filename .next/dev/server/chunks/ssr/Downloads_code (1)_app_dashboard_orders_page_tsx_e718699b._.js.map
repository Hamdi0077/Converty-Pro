{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/p-c/Downloads/code%20%281%29/app/dashboard/orders/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { createClient } from \"@/lib/supabase/client\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface OrderItem {\n  id: string;\n  quantity: number;\n  unit_price: number;\n  product: {\n    id: string;\n    name: string;\n  } | null;\n}\n\ninterface Order {\n  id: string;\n  shop_id: string;\n  customer_name: string;\n  customer_phone: string;\n  customer_city: string | null;\n  customer_address: string;\n  customer_notes: string | null;\n  status: string;\n  total_amount: number;\n  created_at: string;\n  order_items?: OrderItem[];\n}\n\nconst STATUS_OPTIONS = [\"pending\", \"confirmed\", \"shipped\", \"cancelled\"];\n\nexport default function OrdersPage() {\n  const supabase = createClient();\n\n  const [orders, setOrders] = useState<Order[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [errorMsg, setErrorMsg] = useState<string | null>(null);\n  const [updatingId, setUpdatingId] = useState<string | null>(null);\n\n  useEffect(() => {\n    loadOrders();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const loadOrders = async () => {\n    setLoading(true);\n    setErrorMsg(null);\n\n    try {\n      // 1) current user\n      const {\n        data: { user },\n        error: userError,\n      } = await supabase.auth.getUser();\n\n      if (userError) {\n        console.error(\"User error:\", userError);\n      }\n\n      if (!user) {\n        setErrorMsg(\"You must be logged in to see your orders.\");\n        setLoading(false);\n        return;\n      }\n\n      // 2) shops of this user\n      const { data: shops, error: shopsError } = await supabase\n        .from(\"shops\")\n        .select(\"id, name\")\n        .eq(\"user_id\", user.id);\n\n      if (shopsError) {\n        console.error(\"Shops error:\", shopsError);\n        setErrorMsg(\"Error loading your shops.\");\n        setLoading(false);\n        return;\n      }\n\n      if (!shops || shops.length === 0) {\n        setErrorMsg(\"No shop found for this user.\");\n        setLoading(false);\n        return;\n      }\n\n      const shopIds = shops.map((s) => s.id);\n\n      // 3) orders + items + product names\n      const { data: orderRows, error: ordersError } = await supabase\n        .from(\"orders\")\n        .select(\n          `\n          id,\n          shop_id,\n          customer_name,\n          customer_phone,\n          customer_city,\n          customer_address,\n          customer_notes,\n          status,\n          total_amount,\n          created_at,\n          order_items (\n            id,\n            quantity,\n            unit_price,\n            product:products (\n              id,\n              name\n            )\n          )\n        `\n        )\n        .in(\"shop_id\", shopIds)\n        .order(\"created_at\", { ascending: false });\n\n      if (ordersError) {\n        console.error(\"Orders error:\", ordersError);\n        setErrorMsg(\"Error loading orders.\");\n        setLoading(false);\n        return;\n      }\n\n      setOrders((orderRows || []) as unknown as Order[]);\n    } catch (err) {\n      console.error(\"Unexpected orders error:\", err);\n      setErrorMsg(\"Unexpected error while loading orders.\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatDate = (iso: string) =>\n    new Date(iso).toLocaleString(\"fr-FR\", {\n      day: \"2-digit\",\n      month: \"2-digit\",\n      year: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n\n  const formatProducts = (order: Order) => {\n    if (!order.order_items || order.order_items.length === 0) return \"-\";\n\n    return order.order_items\n      .map((item) => {\n        const name = item.product?.name || \"Unknown product\";\n        return `${name} x${item.quantity}`;\n      })\n      .join(\", \");\n  };\n\n  const handleStatusChange = async (orderId: string, newStatus: string) => {\n    try {\n      setUpdatingId(orderId);\n      setErrorMsg(null);\n\n      const { error } = await supabase\n        .from(\"orders\")\n        .update({ status: newStatus })\n        .eq(\"id\", orderId);\n\n      if (error) {\n        console.error(\"Status update error:\", error);\n        setErrorMsg(\"Error updating order status: \" + error.message);\n        return;\n      }\n\n      // Update local state\n      setOrders((prev) =>\n        prev.map((o) =>\n          o.id === orderId\n            ? {\n                ...o,\n                status: newStatus,\n              }\n            : o\n        )\n      );\n    } catch (err: any) {\n      console.error(\"Unexpected status update error:\", err);\n      setErrorMsg(\n        \"Unexpected error updating status: \" + (err?.message || \"see console\")\n      );\n    } finally {\n      setUpdatingId(null);\n    }\n  };\n\n  const statusBadgeClass = (status: string) => {\n    switch (status) {\n      case \"pending\":\n        return \"bg-yellow-100 text-yellow-700\";\n      case \"confirmed\":\n        return \"bg-green-100 text-green-700\";\n      case \"shipped\":\n        return \"bg-blue-100 text-blue-700\";\n      case \"cancelled\":\n        return \"bg-red-100 text-red-700\";\n      default:\n        return \"bg-gray-100 text-gray-700\";\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-xl font-bold\">Orders</h1>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={loadOrders}\n          disabled={loading}\n        >\n          Refresh\n        </Button>\n      </div>\n\n      {errorMsg && (\n        <p className=\"text-sm text-red-500 whitespace-pre-line\">{errorMsg}</p>\n      )}\n\n      {/* Content */}\n      {loading ? (\n        <p>Loading orders...</p>\n      ) : orders.length === 0 ? (\n        <div className=\"border rounded-lg p-6 text-center text-sm text-gray-500\">\n          You don&apos;t have any orders yet.\n        </div>\n      ) : (\n        <div className=\"border rounded-lg overflow-hidden bg-white\">\n          <table className=\"w-full text-sm\">\n            <thead className=\"bg-gray-50\">\n              <tr className=\"text-left\">\n                <th className=\"px-3 py-2\">Date</th>\n                <th className=\"px-3 py-2\">Customer</th>\n                <th className=\"px-3 py-2\">Phone</th>\n                <th className=\"px-3 py-2\">City</th>\n                <th className=\"px-3 py-2\">Products</th>\n                <th className=\"px-3 py-2\">Total</th>\n                <th className=\"px-3 py-2\">Status</th>\n              </tr>\n            </thead>\n            <tbody>\n              {orders.map((o) => (\n                <tr key={o.id} className=\"border-t hover:bg-gray-50 align-top\">\n                  <td className=\"px-3 py-2 whitespace-nowrap\">\n                    {formatDate(o.created_at)}\n                  </td>\n\n                  <td className=\"px-3 py-2\">\n                    <div className=\"font-semibold\">{o.customer_name}</div>\n                    <div className=\"text-xs text-gray-500\">\n                      {o.customer_address}\n                    </div>\n                    {o.customer_notes && (\n                      <div className=\"text-xs text-gray-400 mt-1\">\n                        Note: {o.customer_notes}\n                      </div>\n                    )}\n                  </td>\n\n                  <td className=\"px-3 py-2 whitespace-nowrap\">\n                    {o.customer_phone}\n                  </td>\n\n                  <td className=\"px-3 py-2 whitespace-nowrap\">\n                    {o.customer_city || \"-\"}\n                  </td>\n\n                  {/* Product names */}\n                  <td className=\"px-3 py-2\">\n                    <div className=\"text-xs text-gray-800\">\n                      {formatProducts(o)}\n                    </div>\n                  </td>\n\n                  <td className=\"px-3 py-2 whitespace-nowrap font-semibold\">\n                    {o.total_amount} TND\n                  </td>\n\n                  <td className=\"px-3 py-2 whitespace-nowrap\">\n                    {/* Status badge + select */}\n                    <div className=\"flex flex-col gap-1\">\n                      <span\n                        className={\n                          \"inline-flex px-2 py-1 rounded-full text-xs font-medium \" +\n                          statusBadgeClass(o.status)\n                        }\n                      >\n                        {o.status}\n                      </span>\n\n                      <select\n                        className=\"border rounded-md px-2 py-1 text-xs\"\n                        value={o.status}\n                        disabled={updatingId === o.id}\n                        onChange={(e) =>\n                          handleStatusChange(o.id, e.target.value)\n                        }\n                      >\n                        {STATUS_OPTIONS.map((opt) => (\n                          <option key={opt} value={opt}>\n                            {opt}\n                          </option>\n                        ))}\n                      </select>\n                    </div>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}